<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>JAV品番検索</title>
    <script src="https://unpkg.com/xregexp/xregexp-all.js"></script>
<script>
'use strict';
function outputHTML(category, title, vtype) {
  const avpromo_ = document.getElementById('avpromo');
  const video_ = document.createElement('video');
  video_.setAttribute('controls', true);
  video_.setAttribute('width','90%');
  video_.setAttribute('height', 'auto');
  const vmid = `${category}${title.padStart(5,'0')}`;
  const cover = `https://pics.dmm.co.jp/digital/video/${vmid}/${vmid}pl.jpg`;
  video_.setAttribute('poster', cover);
  const source_ = document.createElement('source');
  source_.setAttribute('type','video/mp4');
  video_.appendChild(source_);
  avpromo_.appendChild(video_);
  const vpath = `${category}${title}`;
  const video = `https://cc3001.dmm.co.jp/litevideo/freepv/${vpath[0]}/${vpath.slice(0,3)}/${vpath}/${vpath}_${vtype}.mp4`;
  source_.setAttribute('src', video);
  // source_.onerror = ErrorRemedy;
  video_.volume = 0;
}
const proxyurl = 'https://cors-anywhere.herokuapp.com/';
const url = av => `https://www.dmm.co.jp/service/digitalapi/-/html5_player/=/cid=${av}/mtype=AhRVShI_/service=digital/floor=videoa/mode=/`; 
const vpattern = /^([0-9a-z_]*[a-z])([0-9]{3,5})$/;
function GetAvp() {
  const avnbr = document.getElementById('avnbr');  
  const m = vpattern.exec(avnbr.value.toLowerCase());
  if (m === null) { return true; }
  const xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function () {
    if (this.readyState === 4 && this.status === 200) {
      const contents = this.responseText;
      console.log(m);
      console.log(contents);
      if (contents.includes(`${m[1]}${m[2].padStart(5,'0')}_dmb_w.mp4\"}]`)) {
        outputHTML(m[1], m[2].padStart(5,'0'), 'dmb_w');
        return;
      }
      if (contents.includes(`${m[1]}${m[2].padStart(3,'0')}_dmb_w.mp4\"}]`)) {
        outputHTML(m[1], m[2].padStart(3,'0'), 'dmb_w');
        return;
      }  
      if (contents.includes(`${m[1]}${m[2].padStart(5,'0')}_dmb_s.mp4\"}]`)) {
        outputHTML(m[1], m[2].padStart(5,'0'), 'dmb_s');
        return;
      }
      if (contents.includes(`${m[1]}${m[2].padStart(3,'0')}_dmb_s.mp4\"}]`)) {
        outputHTML(m[1], m[2].padStart(3,'0'), 'dmb_s');
        return;
      }  
    }
  }   
  xhttp.open("GET", proxyurl + url(avnbr.value.toLowerCase()), true);
  xhttp.send();	
}
</script>
</head>
<body>
    品番：
    <input type="text" name="avnbr" id="avnbr">    
    <button type="button" onclick="GetAvp();">検索</button>
<div id="avpromo"></div>
</body>
</html>
