#!/usr/bin/env bash
WINE=/usr/bin/wine
TXTFILE=${1?"missing text filename ###.txt"}
export LANG=zh_HK.UTF-8 
export WINEPREFIX=$HOME/prefix32
LAST_CHAPTER=$(tail -1 coverparameters.txt | sed 's#^\(...\).*#\1#')
CHAPTER=$(echo $TXTFILE | tr -d .txt)
WAVFILE="$CHAPTER.wav"
MP3FILE="$CHAPTER.mp3"
TITLE=$(grep ^$CHAPTER coverparameters.txt | awk '{print $2;}')
BOOK=$(pwd | sed 's#.*/\([^/]*\)#\1#')
AUDIOPATH=$HOME/audio/$BOOK
[ -d $AUDIOPATH ] || mkdir $AUDIOPATH 
AUTHOR=$(grep \"\>$BOOK $(pwd)/../../*html | sed 's#.*\.\./\.\./\([^.]*\).*#\1#')
DATE=$(date +%F)
$WINE $HOME/mstts/balcon/balcon.exe -enc utf8 2>/dev/null -n HunYee -fr 16 -bt 8 -ch 1 -f $TXTFILE -w $WAVFILE 
ffmpeg -hide_banner -i $WAVFILE -codec:a libmp3lame -metadata artist=$AUTHOR -metadata title=$TITLE -metadata album=【$BOOK】全本廣東話原文照讀 -metadata genre="101"  -metadata date=$DATE  -metadata track="$CHAPTER/$LAST_CHAPTER" $AUDIOPATH/$MP3FILE
rm $WAVFILE
