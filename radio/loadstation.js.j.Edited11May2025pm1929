async function fetchText(file) {
  const response = await fetch(file);
  const text = await response.text();
  return text;
}
let station, group;
let title, stations, groups;
let lastTitle = 'none' 
let lastMode = 'none';
if (!localStorage.getItem('lastTitle')) localStorage.setItem('lastTitle','广东`');
lastTitle = localStorage.getItem('lastTitle');
if (!localStorage.getItem('lastMode')) localStorage.setItem('lastMode','Dark');
lastMode = localStorage.getItem('lastMode');
document.addEventListener("DOMContentLoaded", function(event) {
  myInit();
});
const qingtingUrl = id => `https://lhttp.qingting.fm/live/${id}/64k.mp3`;
const streamUrl = id => (id[0] === 'h') ? id : qingtingUrl(id);
const optionElement = a => `<option value="${streamUrl(a[1])}">${a[0].replace(/_/g,' ')}</option>`;
const groupOptionElement = a => `<option value="${a}" ${(a === title) ? 'selected' : ''}>${a}</option>`;
async function myInit() {
if (lastMode === 'Dark') document.body.classList.toggle("dark-mode");
const gdata = await fetchText('groups.txt');
groups = gdata.replace(/\n+$/, "").split("\n").map(line => line.split(' ')[0]);
const querystring = location.search;
let params = (querystring != '') ? (new URL(document.location)).searchParams : 'none';
if (params === 'none') window.location = `index.html?title=${lastTitle}`;
title =  params.get('title');
title = title ? title : lastTitle;
if (!groups.includes(title))  window.location = `index.html?title=${lastTitle}`;
localStorage.setItem('lastTitle',title);
lastStation = 'none';
lastStation = localStorage.getItem('lastStation'+title) ? localStorage.getItem('lastStation'+title) : 'none'; 
  station = document.getElementById('station');
  group = document.getElementById('group');
  const data = await fetchText(`text/${title}.txt`);
  stations = data.replace(/\n+$/, "").split("\n");
  station.innerHTML = stations.map(line => {
    a = line.split(' ');
    return optionElement(a);
  }).join('\n');
  group.innerHTML = groups.map(t => groupOptionElement(t)).join('\n');
  group.onchange = function() {
    window.location = `index.html?title=${group.value}`; 
  }
}
